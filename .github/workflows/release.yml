name: Release

on:
  push:
    tags:
      - 'v*'  # è§¦å‘æ¡ä»¶ï¼šæ¨é€ä»¥ 'v' å¼€å¤´çš„æ ‡ç­¾ï¼Œå¦‚ v1.0.0

env:
  CARGO_TERM_COLOR: always

jobs:
  build-and-release:
    runs-on: windows-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½®Rustå·¥å…·é“¾
      uses: dtolnay/rust-toolchain@stable
      with:
        toolchain: stable
        
    - name: é…ç½®Rustç¼“å­˜
      uses: Swatinem/rust-cache@v2
      with:
        cache-on-failure: true
        
    - name: æ„å»ºReleaseç‰ˆæœ¬
      run: cargo build --release --verbose
      
    - name: ä¸‹è½½å¹¶è®¾ç½®UPX
      run: |
        # ä¸‹è½½UPX
        Invoke-WebRequest -Uri "https://github.com/upx/upx/releases/download/v4.2.2/upx-4.2.2-win64.zip" -OutFile "upx.zip"
        # è§£å‹UPX
        Expand-Archive -Path "upx.zip" -DestinationPath "."
        # å°†UPXæ·»åŠ åˆ°PATH
        $env:PATH += ";$PWD\upx-4.2.2-win64"
        echo "$PWD\upx-4.2.2-win64" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
      shell: pwsh
      
    - name: ä½¿ç”¨UPXå‹ç¼©å¯æ‰§è¡Œæ–‡ä»¶
      run: |
        # å‹ç¼©å¯æ‰§è¡Œæ–‡ä»¶
        upx --best --lzma target/release/crack.exe
        # æ˜¾ç¤ºå‹ç¼©åçš„æ–‡ä»¶ä¿¡æ¯
        Get-ChildItem target/release/crack.exe | Format-Table Name, Length
      shell: pwsh
      
    - name: å‡†å¤‡å‘å¸ƒæ–‡ä»¶
      run: |
        # åˆ›å»ºå‘å¸ƒç›®å½•
        New-Item -ItemType Directory -Force -Path "release"
        # å¤åˆ¶å¯æ‰§è¡Œæ–‡ä»¶
        Copy-Item "target/release/crack.exe" "release/crack-windows-x64.exe"
        # å¤åˆ¶é…ç½®æ–‡ä»¶ç¤ºä¾‹
        Copy-Item "config.json" "release/config-example.json" -ErrorAction SilentlyContinue
        # åˆ›å»ºREADME
        @"
        # Crack - è½¯ä»¶è®¸å¯è¯ç”Ÿæˆå·¥å…·

        ## ä½¿ç”¨æ–¹æ³•

        1. å°† crack-windows-x64.exe é‡å‘½åä¸º crack.exe
        2. é¦–æ¬¡è¿è¡Œä¼šè‡ªåŠ¨ç”Ÿæˆ config.json é…ç½®æ–‡ä»¶
        3. æ ¹æ®éœ€è¦ä¿®æ”¹é…ç½®æ–‡ä»¶ä¸­çš„å‚æ•°
        4. è¿è¡Œå‘½ä»¤ç”Ÿæˆè®¸å¯è¯ï¼š
           - MobaXterm: crack.exe mobaxterm
           - JetBrains: crack.exe jetbrains

        ## é…ç½®è¯´æ˜

        è¯·å‚è€ƒ config-example.json æ–‡ä»¶è¿›è¡Œé…ç½®ã€‚

        ## æ³¨æ„äº‹é¡¹

        æœ¬å·¥å…·ä»…ä¾›å­¦ä¹ å’Œç ”ç©¶ä½¿ç”¨ï¼Œè¯·éµå®ˆç›¸å…³æ³•å¾‹æ³•è§„ã€‚
        "@ | Out-File -FilePath "release/README.txt" -Encoding UTF8
      shell: pwsh
      
    - name: è·å–æ ‡ç­¾ä¿¡æ¯
      id: tag_info
      run: |
        $tag = $env:GITHUB_REF -replace 'refs/tags/', ''
        echo "tag=$tag" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
        echo "Tag: $tag"
      shell: pwsh
      
    - name: åˆ›å»ºGitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.tag_info.outputs.tag }}
        name: Release ${{ steps.tag_info.outputs.tag }}
        body: |
          ## ğŸ‰ æ–°ç‰ˆæœ¬å‘å¸ƒ

          ### ğŸ“¦ ä¸‹è½½æ–‡ä»¶
          - `crack-windows-x64.exe` - Windows x64 å¯æ‰§è¡Œæ–‡ä»¶ï¼ˆå·²ä½¿ç”¨UPXå‹ç¼©ï¼‰
          - `config-example.json` - é…ç½®æ–‡ä»¶ç¤ºä¾‹
          - `README.txt` - ä½¿ç”¨è¯´æ˜

          ### ğŸš€ åŠŸèƒ½ç‰¹æ€§
          - æ”¯æŒç”ŸæˆMobaXtermä¸“ä¸šç‰ˆè®¸å¯è¯
          - æ”¯æŒç”ŸæˆJetBrainsç³»åˆ—IDEè®¸å¯è¯
          - å‹å¥½çš„ä¸­æ–‡ç•Œé¢å’Œæç¤º
          - è¯¦ç»†çš„é…ç½®éªŒè¯å’Œé”™è¯¯æç¤º

          ### ğŸ“‹ ä½¿ç”¨æ–¹æ³•
          1. ä¸‹è½½ `crack-windows-x64.exe` å¹¶é‡å‘½åä¸º `crack.exe`
          2. é¦–æ¬¡è¿è¡Œä¼šè‡ªåŠ¨ç”Ÿæˆé…ç½®æ–‡ä»¶
          3. æ ¹æ®éœ€è¦ä¿®æ”¹é…ç½®å‚æ•°
          4. è¿è¡Œç›¸åº”å‘½ä»¤ç”Ÿæˆè®¸å¯è¯

          ### âš ï¸ å…è´£å£°æ˜
          æœ¬å·¥å…·ä»…ä¾›å­¦ä¹ å’Œç ”ç©¶ä½¿ç”¨ï¼Œè¯·éµå®ˆç›¸å…³æ³•å¾‹æ³•è§„ã€‚

          ---
          
          **æ„å»ºä¿¡æ¯:**
          - æ„å»ºæ—¶é—´: ${{ github.event.head_commit.timestamp }}
          - æäº¤å“ˆå¸Œ: ${{ github.sha }}
          - Rustç‰ˆæœ¬: stable
          - å‹ç¼©å·¥å…·: UPX v4.2.2
        files: |
          release/crack-windows-x64.exe
          release/config-example.json
          release/README.txt
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: æ˜¾ç¤ºæ„å»ºä¿¡æ¯
      run: |
        echo "ğŸ‰ æ„å»ºå®Œæˆï¼"
        echo "ğŸ“¦ å‘å¸ƒæ–‡ä»¶ï¼š"
        Get-ChildItem release/ | Format-Table Name, Length
        echo "ğŸ·ï¸ æ ‡ç­¾: ${{ steps.tag_info.outputs.tag }}"
        echo "ğŸ”— Releaseé“¾æ¥: https://github.com/${{ github.repository }}/releases/tag/${{ steps.tag_info.outputs.tag }}"
      shell: pwsh
